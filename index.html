<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GetKey Panel</title>
  <style>
    :root{
      --bg0:#070812;
      --bg1:#0a1026;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --text:#e9ecff;
      --muted:rgba(233,236,255,.70);
      --line:rgba(255,255,255,.12);
      --acc:#7c5cff;
      --acc2:#2be7c5;
      --bad:#ff4d6d;
      --ok:#2be7c5;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(800px 500px at 80% 30%, rgba(43,231,197,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* subtle moving glow */
    .glow{
      position:fixed; inset:-200px;
      pointer-events:none;
      background:
        radial-gradient(500px 400px at 30% 20%, rgba(124,92,255,.18), transparent 60%),
        radial-gradient(600px 500px at 70% 35%, rgba(43,231,197,.12), transparent 60%),
        radial-gradient(700px 550px at 45% 80%, rgba(255,77,109,.08), transparent 60%);
      filter: blur(35px);
      animation: float 10s ease-in-out infinite alternate;
      opacity:.9;
    }
    @keyframes float{
      from{transform: translate3d(-10px,-8px,0) scale(1)}
      to  {transform: translate3d(14px,10px,0) scale(1.02)}
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 26px 16px 46px;
      position:relative;
    }

    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 14px 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .logo{
      width:38px; height:38px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(43,231,197,.9));
      box-shadow: 0 12px 30px rgba(124,92,255,.18);
      position:relative;
      overflow:hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(135deg, rgba(255,255,255,.22), transparent 60%);
      transform: rotate(25deg);
      animation: sheen 2.8s ease-in-out infinite;
    }
    @keyframes sheen{
      0%{transform:translateX(-60%) rotate(25deg)}
      55%{transform:translateX(60%) rotate(25deg)}
      100%{transform:translateX(60%) rotate(25deg)}
    }
    .brand h1{
      font-size: 16px;
      margin:0;
      letter-spacing:.2px;
      line-height:1.15;
    }
    .brand p{
      margin:4px 0 0;
      color:var(--muted);
      font-size: 12.5px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      font-size:12.5px;
      color: var(--muted);
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: rgba(255,255,255,.18);
      box-shadow: 0 0 0 6px rgba(255,255,255,.05);
    }
    .dot.ok{background: rgba(43,231,197,.95); box-shadow: 0 0 0 6px rgba(43,231,197,.10)}
    .dot.bad{background: rgba(255,77,109,.95); box-shadow: 0 0 0 6px rgba(255,77,109,.10)}

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      margin-top: 14px;
    }
    @media (max-width: 880px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      position:relative;
    }
    .card .hd{
      padding: 16px 16px 0;
    }
    .card .hd h2{
      margin:0;
      font-size: 15px;
      letter-spacing:.2px;
    }
    .card .hd p{
      margin:6px 0 0;
      color:var(--muted);
      font-size: 12.5px;
    }
    .card .bd{
      padding: 14px 16px 16px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 520px){
      .row{grid-template-columns: 1fr;}
    }

    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px;
    }
    .input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(8,10,20,.38);
      color: var(--text);
      outline: none;
      transition: .18s ease;
    }
    .input:focus, select:focus{
      border-color: rgba(124,92,255,.7);
      box-shadow: 0 0 0 5px rgba(124,92,255,.12);
      transform: translateY(-1px);
    }
    .hint{
      margin-top:6px;
      font-size: 12px;
      color: rgba(233,236,255,.62);
    }

    .btns{
      display:flex;
      gap:10px;
      margin-top: 12px;
      flex-wrap:wrap;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      cursor:pointer;
      transition: .18s ease;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08)}
    .btn:active{transform: translateY(0px) scale(.99)}
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(43,231,197,.85));
      box-shadow: 0 16px 40px rgba(124,92,255,.18);
    }
    .btn.primary:hover{filter: brightness(1.02)}
    .btn.danger{
      border:1px solid rgba(255,77,109,.35);
      background: rgba(255,77,109,.08);
    }

    .icon{
      width:16px;height:16px; display:inline-block;
    }

    .out{
      margin-top: 12px;
      border-top: 1px solid var(--line);
      padding-top: 12px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      padding: 10px 12px;
      border-radius: 14px;
      overflow:auto;
      max-height: 210px;
      line-height:1.35;
      font-size: 12.5px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .keyline{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin: 10px 0 8px;
    }
    .keypill{
      font-family: ui-monospace, monospace;
      letter-spacing:.6px;
      font-weight: 700;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(43,231,197,.35);
      background: rgba(43,231,197,.08);
      color: rgba(233,255,250,.95);
    }

    .spinner{
      width:16px;height:16px;
      border-radius:50%;
      border: 2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.88);
      animation: spin .85s linear infinite;
    }
    @keyframes spin{to{transform: rotate(360deg)}}

    /* toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(20px);
      background: rgba(10,12,24,.72);
      border: 1px solid rgba(255,255,255,.14);
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      opacity:0;
      pointer-events:none;
      transition: .22s ease;
      max-width: 92vw;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(0px);
    }
    .toast b{color:var(--text)}
    .toast span{color:var(--muted); margin-left:8px}
    .toast .t-ok{color: var(--ok)}
    .toast .t-bad{color: var(--bad)}

    .mini{
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }
    a{color: rgba(180,210,255,.95); text-decoration: none}
    a:hover{text-decoration: underline}
  </style>
</head>
<body>
  <div class="glow"></div>

  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>GetKey Panel</h1>
          <p>GitHub Pages ‚Üí Firestore REST (t·∫°o key + l∆∞u fields)</p>
        </div>
      </div>

      <div class="pill" id="statusPill">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Ch∆∞a ki·ªÉm tra c·∫•u h√¨nh</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="hd">
          <h2>T·∫°o key</h2>
          <p>Generate key ng·∫´u nhi√™n, set h·∫°n d√πng, max uses‚Ä¶ r·ªìi b·∫Øn l√™n Firestore collection <b>keys</b>.</p>
        </div>
        <div class="bd">
          <div class="row">
            <div class="field">
              <label>Prefix</label>
              <input class="input" id="prefix" value="HH" placeholder="VD: HH" />
              <div class="hint">Key s·∫Ω c√≥ d·∫°ng: <b>PREFIX-XXXXXXXXXXXX</b></div>
            </div>
            <div class="field">
              <label>ƒê·ªô d√†i ph·∫ßn random</label>
              <select id="len">
                <option value="8">8</option>
                <option value="10">10</option>
                <option value="12" selected>12</option>
                <option value="16">16</option>
              </select>
              <div class="hint">D√†i h∆°n ‚Üí kh√≥ tr√πng h∆°n.</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>H·∫°n d√πng (ng√†y) ‚Äì expires_seconds</label>
              <input class="input" id="days" type="number" min="1" value="1" />
              <div class="hint">1 ng√†y = 86400s. App s·∫Ω set <code>first_used</code> l·∫ßn ƒë·∫ßu.</div>
            </div>
            <div class="field">
              <label>Max uses (s·ªë thi·∫øt b·ªã)</label>
              <input class="input" id="maxUses" type="number" min="1" value="1" />
              <div class="hint">Gi·ªëng field <code>max_uses</code>.</div>
            </div>
          </div>

          <div class="btns">
            <button class="btn primary" id="btnGen">
              <span class="icon">‚ö°</span>
              <span>T·∫†O KEY</span>
              <span id="sp" style="display:none" class="spinner"></span>
            </button>

            <button class="btn" id="btnCopy" disabled>
              <span class="icon">üìã</span>
              <span>Copy key</span>
            </button>

            <button class="btn danger" id="btnClear">
              <span class="icon">üßπ</span>
              <span>Clear</span>
            </button>
          </div>

          <div class="out" id="outBox" style="display:none">
            <div class="keyline">
              <div class="keypill" id="keyPill">‚Äî</div>
              <a id="fireLink" href="#" target="_blank" rel="noopener">M·ªü trong Firestore</a>
            </div>
            <div class="kbd" id="log"></div>
            <div class="mini">
              Tip: N·∫øu b·∫•m t·∫°o key m√† b√°o <b>Already exists</b> ‚Üí panel s·∫Ω t·ª± retry key kh√°c.
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <h2>C·∫•u h√¨nh</h2>
          <p>S·ª≠a 2 d√≤ng <b>PROJECT_ID</b> + <b>API_KEY</b> trong code. Xong b·∫•m ‚ÄúTest‚Äù.</p>
        </div>
        <div class="bd">
          <div class="field">
            <label>PROJECT_ID</label>
            <input class="input" id="pid" />
            <div class="hint">V√≠ d·ª•: <code>key-tool-bb37b</code></div>
          </div>

          <div class="field" style="margin-top:12px">
            <label>WEB API KEY</label>
            <input class="input" id="akey" />
            <div class="hint">Chu·ªói b·∫Øt ƒë·∫ßu b·∫±ng <code>AIzaSy...</code></div>
          </div>

          <div class="btns">
            <button class="btn" id="btnTest">
              <span class="icon">üß™</span>
              <span>Test Firestore</span>
            </button>
          </div>

          <div class="out" style="margin-top:12px">
            <div class="kbd" id="cfgNote">Ch∆∞a test.</div>
            <div class="mini">
              (Khuy·∫øn ngh·ªã) Restrict API key theo domain GitHub Pages ƒë·ªÉ ƒë·ª° b·ªã ng∆∞·ªùi kh√°c x√†i k√©.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mini" style="margin-top:16px">
      <b>L∆∞u √Ω b·∫£o m·∫≠t:</b> ki·ªÉu ‚ÄúGitHub Pages + Firestore REST‚Äù l√† panel client-side, n√™n API key s·∫Ω l·ªô trong source.
      Mu·ªën ƒë·ª° b·ªã abuse ‚Üí h√£y <b>restrict API key</b> theo domain, v√† rules Firestore t·ªëi thi·ªÉu quy·ªÅn.
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/** =========================
 *  1) S·ª¨A 2 D√íNG N√ÄY
 *  ========================= */
const CFG = {
  PROJECT_ID: "key-tool-bb37b",        // <-- thay project id c·ªßa b·∫°n
  API_KEY: "AIzaSyDR73HZ6MyMF5GRgw3bx_c7vExGuGmzLs4",    // <-- thay Web API Key c·ªßa b·∫°n
  COLLECTION: "keys"
};
/** ========================= */

const $ = (id) => document.getElementById(id);

function setStatus(ok, text){
  $("statusText").textContent = text;
  $("statusDot").className = "dot " + (ok ? "ok" : "bad");
}

function toast(ok, title, msg=""){
  const el = $("toast");
  el.innerHTML = `<b class="${ok ? 't-ok' : 't-bad'}">${title}</b><span>${msg}</span>`;
  el.classList.add("show");
  setTimeout(()=> el.classList.remove("show"), 2200);
}

function log(obj){
  $("outBox").style.display = "block";
  const s = (typeof obj === "string") ? obj : JSON.stringify(obj, null, 2);
  $("log").textContent = s;
}

function cfgLog(s){ $("cfgNote").textContent = s; }

function baseUrl(){
  return `https://firestore.googleapis.com/v1/projects/${CFG.PROJECT_ID}/databases/(default)/documents/${CFG.COLLECTION}`;
}

// crypto random
function randKey(prefix, len){
  const alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // b·ªè I O 0 1 cho ƒë·ª° nh·∫ßm
  const bytes = new Uint8Array(len);
  crypto.getRandomValues(bytes);
  let out = "";
  for (let i=0;i<len;i++){
    out += alphabet[bytes[i] % alphabet.length];
  }
  return `${prefix}-${out}`;
}

function firestoreConsoleLink(docId){
  // Link console d·∫°ng data path
  const enc = encodeURIComponent(`keys/${docId}`);
  return `https://console.firebase.google.com/project/${CFG.PROJECT_ID}/firestore/databases/-default-/data/${enc}`;
}

async function testFirestore(){
  // test b·∫±ng c√°ch GET collection root (kh√¥ng ph·∫£i list doc) -> th∆∞·ªùng 404/403 tu·ª≥ rules,
  // n√™n ta test b·∫±ng runQuery nh·∫π: check xem API key + project id ƒë√∫ng hay kh√¥ng b·∫±ng call invalid doc (expect 404, not 403)
  const url = `${baseUrl()}/__test__?key=${encodeURIComponent(CFG.API_KEY)}`;
  try{
    const r = await fetch(url, { method: "GET" });
    const t = await r.text();
    if (r.status === 403){
      setStatus(false, "403 (Rules/API key h·∫°n ch·∫ø)");
      cfgLog("403: API key ƒë√∫ng nh∆∞ng Firestore Rules/Restriction ƒëang ch·∫∑n. N·∫øu b·∫°n mu·ªën web t·∫°o key, rules ph·∫£i allow create.");
      return;
    }
    if (r.status === 404){
      setStatus(true, "OK (project/api key h·ª£p l·ªá)");
      cfgLog("OK: project + api key c√≥ v·∫ª ƒë√∫ng (404 l√† b√¨nh th∆∞·ªùng v√¨ doc __test__ kh√¥ng t·ªìn t·∫°i).");
      return;
    }
    // c√°c status kh√°c v·∫´n log ƒë·ªÉ b·∫°n xem
    setStatus(false, `Status ${r.status}`);
    cfgLog(`Status ${r.status}: ${t}`);
  }catch(e){
    setStatus(false, "Network/JS error");
    cfgLog(String(e));
  }
}

function setLoading(on){
  $("sp").style.display = on ? "inline-block" : "none";
  $("btnGen").disabled = on;
}

async function createKeyOnFirestore(docId, expiresSeconds, maxUses){
  const url = `${baseUrl()}?documentId=${encodeURIComponent(docId)}&key=${encodeURIComponent(CFG.API_KEY)}`;

  const body = {
    fields: {
      expires: { integerValue: "0" },
      expires_seconds: { integerValue: String(expiresSeconds) },
      device_id: { stringValue: "" },
      first_used: { integerValue: "0" },
      max_uses: { integerValue: String(maxUses) },
      current_uses: { integerValue: "0" }
    }
  };

  const r = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });

  const text = await r.text();
  let json;
  try{ json = JSON.parse(text); }catch{ json = text; }

  return { ok: r.ok, status: r.status, data: json };
}

async function genAndCreate(){
  const prefix = ($("prefix").value || "HH").trim().toUpperCase();
  const len = parseInt($("len").value, 10) || 12;
  const days = Math.max(1, parseInt($("days").value, 10) || 1);
  const maxUses = Math.max(1, parseInt($("maxUses").value, 10) || 1);
  const expiresSeconds = days * 86400;

  setLoading(true);
  $("btnCopy").disabled = true;

  try{
    // retry n·∫øu tr√πng key (409)
    for (let attempt=1; attempt<=6; attempt++){
      const key = randKey(prefix, len);
      const res = await createKeyOnFirestore(key, expiresSeconds, maxUses);

      if (res.ok){
        $("keyPill").textContent = key;
        $("fireLink").href = firestoreConsoleLink(key);
        log({
          message: "CREATED",
          key,
          expires_seconds: expiresSeconds,
          max_uses: maxUses,
          firestore_response: res.data
        });
        toast(true, "T·∫°o key OK", key);
        $("btnCopy").disabled = false;
        return;
      }

      // already exists => retry
      const isAlready =
        res.status === 409 ||
        (typeof res.data === "object" && res.data?.error?.status === "ALREADY_EXISTS");

      if (isAlready){
        if (attempt === 6){
          log({ error: "Tr√πng key qu√° nhi·ªÅu l·∫ßn", last: res });
          toast(false, "ERROR", "Tr√πng key nhi·ªÅu l·∫ßn");
          return;
        }
        continue;
      }

      // c√°c l·ªói kh√°c -> show lu√¥n
      log({ error: "CREATE FAILED", status: res.status, detail: res.data });
      toast(false, "ERROR", `Status ${res.status}`);
      return;
    }
  }catch(e){
    log({ error: "JS ERROR", detail: String(e) });
    toast(false, "JS ERROR", String(e));
  }finally{
    setLoading(false);
  }
}

async function copyKey(){
  const key = $("keyPill").textContent.trim();
  if (!key || key === "‚Äî") return;
  try{
    await navigator.clipboard.writeText(key);
    toast(true, "ƒê√£ copy", key);
  }catch{
    // fallback
    const ta = document.createElement("textarea");
    ta.value = key;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    toast(true, "ƒê√£ copy", key);
  }
}

function clearOut(){
  $("outBox").style.display = "none";
  $("log").textContent = "";
  $("keyPill").textContent = "‚Äî";
  $("btnCopy").disabled = true;
}

function syncCfgUI(){
  $("pid").value = CFG.PROJECT_ID;
  $("akey").value = CFG.API_KEY;
}

function applyCfgFromUI(){
  CFG.PROJECT_ID = $("pid").value.trim();
  CFG.API_KEY = $("akey").value.trim();
  toast(true, "ƒê√£ √°p d·ª•ng config");
}

$("btnGen").addEventListener("click", genAndCreate);
$("btnCopy").addEventListener("click", copyKey);
$("btnClear").addEventListener("click", clearOut);

$("btnTest").addEventListener("click", async ()=>{
  applyCfgFromUI();
  await testFirestore();
});

syncCfgUI();
setStatus(false, "Ch∆∞a test");
cfgLog("Nh·∫≠p PROJECT_ID + API_KEY r·ªìi b·∫•m Test Firestore.");
</script>

</body>
</html>
