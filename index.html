<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Get Key</title>
<style>
:root{
  --bg:#0b1022; --card:rgba(255,255,255,.07); --line:rgba(255,255,255,.12);
  --txt:#e9ecff; --mut:rgba(233,236,255,.65); --acc:#7c5cff; --ok:#2be7c5;
}
*{box-sizing:border-box}
body{
  margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--txt);
  background:
    radial-gradient(800px 400px at 20% 10%, rgba(124,92,255,.22), transparent 60%),
    radial-gradient(700px 400px at 80% 30%, rgba(43,231,197,.16), transparent 55%),
    linear-gradient(180deg,#070812,var(--bg));
}
.card{
  width:100%; max-width:420px; text-align:center; padding:22px 20px 26px;
  background:var(--card); border:1px solid var(--line); border-radius:20px;
  backdrop-filter:blur(12px); box-shadow:0 25px 80px rgba(0,0,0,.45);
}
.logo{
  width:56px;height:56px;margin:0 auto 14px;border-radius:16px;
  background:linear-gradient(135deg,#7c5cff,#2be7c5);
  box-shadow:0 12px 40px rgba(124,92,255,.35);
}
h1{margin:6px 0 4px;font-size:20px}
p{margin:0 0 18px;font-size:13px;color:var(--mut)}
button{
  width:100%; border:none; border-radius:16px; padding:14px 16px;
  font-size:15px; font-weight:600; cursor:pointer; color:white;
  background:linear-gradient(135deg,#7c5cff,#2be7c5);
  box-shadow:0 16px 40px rgba(124,92,255,.35); transition:.2s;
}
button:hover{transform:translateY(-1px);filter:brightness(1.05)}
button:active{transform:scale(.98)}
.key{
  margin-top:16px; padding:12px; border-radius:14px;
  border:1px solid rgba(43,231,197,.35); background:rgba(43,231,197,.1);
  font-family:ui-monospace,monospace; font-weight:700; letter-spacing:.6px;
  display:none; word-break:break-all;
}
.note{margin-top:10px;font-size:12px;color:var(--mut)}
</style>
</head>
<body>

<div class="card">
  <div class="logo"></div>
  <h1>Nhận Key</h1>
  <p>Bấm nút bên dưới để lấy key sử dụng tool</p>
  <button id="btn">⚡ LẤY KEY</button>
  <div class="key" id="keyBox"></div>
  <div class="note" id="note"></div>
</div>

<script>
/* ===== CONFIG ẨN ===== */
const PROJECT_ID = "key-tool-bb37b";
const API_KEY    = "AIzaSyDR73HZ6MyMF5GRgw3bx_c7vExGuGmzLs4";   // Web API Key Firebase
const COLLECTION = "keys";

/* Link gate VuotNhanh (copy từ VuotNhanh sau khi tạo API) */
const GATE_URL   = "https://vuotnhanh.com/abcXYZ";

/* Key settings */
const PREFIX = "HH";
const RANDOM_LEN = 12;
const EXPIRES_SECONDS = 86400; // 1 ngày
const MAX_USES = 1;

/* ===== Utils ===== */
function qs(name){ return new URLSearchParams(location.search).get(name); }
function randKey(){
  const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
  const arr = new Uint8Array(RANDOM_LEN);
  crypto.getRandomValues(arr);
  let out=""; for(let i=0;i<arr.length;i++) out += chars[arr[i]%chars.length];
  return `${PREFIX}-${out}`;
}

async function createKey(){
  for(let i=0;i<6;i++){
    const key = randKey();
    const url =
      `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}`+
      `/databases/(default)/documents/${COLLECTION}`+
      `?documentId=${encodeURIComponent(key)}&key=${encodeURIComponent(API_KEY)}`;

    const body = {
      fields:{
        expires:{integerValue:"0"},
        expires_seconds:{integerValue:String(EXPIRES_SECONDS)},
        device_id:{stringValue:""},
        first_used:{integerValue:"0"},
        max_uses:{integerValue:String(MAX_USES)},
        current_uses:{integerValue:"0"}
      }
    };

    const r = await fetch(url,{
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify(body)
    });
    if(r.ok) return key;
  }
  throw new Error("Create key failed");
}

/* ===== Gate flow ===== */
function goGate(){
  sessionStorage.setItem("want_key","1");
  location.href = GATE_URL;
}

async function afterGate(){
  // VuotNhanh redirect về ?ok=1
  if(qs("ok") !== "1") return null;
  if(sessionStorage.getItem("want_key") !== "1") return null;

  sessionStorage.removeItem("want_key");
  history.replaceState({}, "", location.origin + location.pathname);

  return await createKey();
}

/* ===== UI ===== */
const btn = document.getElementById("btn");
const box = document.getElementById("keyBox");
const note = document.getElementById("note");

btn.onclick = ()=>{
  box.style.display="none";
  note.textContent="Đang chuyển sang trang xác nhận…";
  goGate();
};

(async ()=>{
  try{
    const key = await afterGate();
    if(key){
      box.textContent = key;
      box.style.display="block";
      note.textContent="Đã xác nhận. Key đã copy!";
      navigator.clipboard.writeText(key);
    }
  }catch(e){
    note.textContent="Xác nhận thất bại, thử lại.";
  }
})();
</script>

</body>
</html>
